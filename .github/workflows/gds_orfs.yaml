name: gds_orfs

on:
  push:
  workflow_dispatch:

jobs:
  gds_orfs:
    runs-on: ubuntu-24.04
    env:
      TT_TOOLS_REPO: TinyTapeout/tt-support-tools
      TT_TOOLS_REF: main
      LIBRELANE_VERSION: 2.4.2
      PDK: gf180mcuD
    steps:
      - name: Checkout design repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up environment variables
        shell: bash
        run: |
          PDK=$PDK
          PDK_ROOT=/home/runner/pdk
          TT_ARGS="--gf"

          cat <<__EOF >> $GITHUB_ENV
          PDK=$PDK
          PDK_ROOT=$PDK_ROOT
          TT_ARGS=$TT_ARGS
          __EOF

      - name: Install prerequisites
        uses: awalsh128/cache-apt-pkgs-action@v1.4.3
        with:
          packages: librsvg2-bin pngquant ghdl-llvm
          version: tinytapeout_gds_action

      - name: Checkout tt-support-tools repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TT_TOOLS_REPO }}
          ref: ${{ env.TT_TOOLS_REF }}
          path: tt

      - name: Setup python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install tt-support-tools dependencies
        shell: bash
        run: pip install -r tt/requirements.txt

      - name: Fetch verilog and build config
        shell: bash
        run: ./tt/tt_tool.py --create-user-config ${{ env.TT_ARGS }}

      - name: Install LibreLane
        shell: bash
        run: pip install librelane==${{ env.LIBRELANE_VERSION }}

      - name: Patch LibreLane synth flow (pre-map $fa, skip ABC flattening)
        shell: bash
        run: |
          python - <<'PY'
          import importlib.util
          import pathlib
          import sys
          spec = importlib.util.find_spec("librelane.scripts.pyosys.synthesize")
          if spec is None or spec.origin is None:
              sys.exit("Could not locate librelane.scripts.pyosys.synthesize")
          path = pathlib.Path(spec.origin)
          text = path.read_text()
          # Insert maccmap + early fa_map
          old_block = (
              '    d.run_pass("alumacc")  # Optimize arithmetic logic unitsb\n'
              '    d.run_pass("share")  # Share logic across the design\n'
          )
          new_block = (
              '    d.run_pass("alumacc")  # Optimize arithmetic logic units\n'
              '    d.run_pass("maccmap", "-auto", "-fa", "-ha")  # Preserve full/half adders\n'
              '    d.run_pass("techmap", "-map", "src/fa_map.v")  # Map $fa early to tech cells\n'
              '    d.run_pass("share")  # Share logic across the design\n'
          )
          if old_block not in text:
              sys.exit("Expected block not found in synthesize.py; LibreLane version may have changed")
          text = text.replace(old_block, new_block, 1)
          # Remove generic techmap/abc that flatten multi-output cells
          text = text.replace(
              '    d.run_pass("techmap")  # Map to primitive gates\n\n'
              '    # Couple more fast opt iterations\n'
              '    librelane_opt(d, fast=True)\n'
              '    librelane_opt(d, fast=True)\n',
              ''
          )
          text = text.replace(
              '    d.run_pass(\n'
              '        "abc", "-fast", *(["-dff"] if abc_dff else [])\n'
              '    )  # Run ABC with fast settings\n'
              '    d.run_pass("opt", "-fast")  # MORE fast optimization\n\n'
              '    # Checks and Stats\n'
              '    d.run_pass("hierarchy", "-check", "-top", top, "-nokeep_prints", "-nokeep_asserts")\n'
              '    d.run_pass("check")\n'
              '    d.run_pass("stat")\n',
              ''
          )
          path.write_text(text)
          print(f"Patched {path} to insert maccmap/map and skip techmap/ABC")
          PY

      - name: Make GDS with LibreLane (ORFS-like)
        shell: bash
        run: ./tt/tt_tool.py --harden ${{ env.TT_ARGS }}

      - name: Publish build logs
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: GDS_logs_orfs
          path: runs/wokwi/*

      - name: Prepare tt_submission artifact
        shell: bash
        run: ./tt/tt_tool.py --create-tt-submission ${{ env.TT_ARGS }}

      - name: Publish tt_submission artifact
        uses: actions/upload-artifact@v4
        with:
          name: tt_submission
          path: |
            src/*
            docs/*
            tt_submission/*
            info.yaml
            LICENSE

      - name: Render PNG from GDS
        shell: bash
        run: './tt/tt_tool.py --create-png ${{ env.TT_ARGS }} 2>&1 || echo "WARNING: Failed to render PNG preview from GDS; error $?"'

      - name: Upload gds_render (png) artifact
        uses: actions/upload-artifact@v4
        with:
          name: gds_render
          path: gds_render.png

  precheck:
    needs: gds_orfs
    runs-on: ubuntu-24.04
    steps:
      - name: Run Tiny Tapeout Precheck
        uses: TinyTapeout/tt-gds-action/precheck@ttgf0p2

  gl_test:
    needs: gds_orfs
    runs-on: ubuntu-24.04
    steps:
      - name: checkout repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: GL test
        uses: TinyTapeout/tt-gds-action/gl_test@ttgf0p2

  viewer:
    needs: gds_orfs
    runs-on: ubuntu-24.04
    permissions:
      pages: write
      id-token: write
    steps:
      - uses: TinyTapeout/tt-gds-action/viewer@ttgf0p2
